name: validate-solutions
on:
  push:
    paths:
      - solutions/**
  pull_request:
    branches: [main]

jobs:
  render-and-validate:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v1
      
      - name: 'Render All Solutions - kpt fn render'
        run: |
          # remove the arete solutions.yaml, it fails rendering because it doens't have an 'apiVersion' defined
          rm solutions/solutions.yaml

          # initialize the entire solutions folder as a kpt package
          docker run -v $PWD:/app -v /var/run/docker.sock:/var/run/docker.sock gcr.io/kpt-dev/kpt:v1.0.0-beta.27 pkg init /app/solutions
          
          # render the entire solutions folder
          docker run -v $PWD:/app -v /var/run/docker.sock:/var/run/docker.sock gcr.io/kpt-dev/kpt:v1.0.0-beta.27 fn render /app/solutions --truncate-output=false
      
      - name: 'Upload Rendered Solutions Artifact'
        uses: actions/upload-artifact@v3
        with:
          name: all-solutions-render
          path: ./solutions
          retention-days: 1

      - name: 'Download Rendered Solutions Artifact'
        uses: actions/download-artifact@v3
        with:
          name: all-solutions-render
      
      - name: dir check
        run: pwd && ls
      
      - name: nomos vet all solutions
        run: |
          docker run -v $PWD/solutions:/solutions gcr.io/config-management-release/nomos:v1.14.2 vet --no-api-server-check --source-format unstructured --path /solutions